swagger: "2.0"
info:
  description: "API for the WhoKnows web app: session auth, search content, weather forecast, and health/readiness probes."
  title: WhoKnows API
  contact: {}
  version: 0.1.0

host: ""
basePath: /
schemes: []

securityDefinitions:
  CookieAuth:
    type: apiKey
    in: cookie
    name: session
    description: Session-based authentication set via /api/login endpoint.

# Global rule: alt kræver session-cookie, medmindre der står security: []
security:
  - CookieAuth: []

paths:
  /about:
    get:
      security: []  # Public
      produces:
        - text/html
      tags:
        - Pages
      summary: Serve About Page
      responses:
        "200":
          description: HTML content
          schema:
            type: string

  /api/login:
    post:
      security: []  # Public
      description: Authenticate a user with username and password. Sets a session cookie and redirects to the home page on success.
      consumes:
        - application/x-www-form-urlencoded
      produces:
        - text/html
      tags:
        - API
      summary: Login
      parameters:
        - name: username
          in: formData
          description: Username
          required: true
          type: string
        - name: password
          in: formData
          description: Password
          required: true
          type: string
      responses:
        "302":
          description: Redirect to / after successful login
        "200":
          description: Login page with validation error

  /api/logout:
    get:
      security: []  # Public
      description: Log out the current user by clearing the session cookie.
      produces:
        - text/html
      tags:
        - API
      summary: Logout
      responses:
        "302":
          description: Redirect to / after logout
    post:
      security: []  # Public
      consumes: []  # eksplicit ingen body
      description: Log out the current user by clearing the session cookie.
      produces:
        - text/html
      tags:
        - API
      summary: Logout
      responses:
        "302":
          description: Redirect to / after logout

  /api/register:
    post:
      security: []  # Public
      description: Register a new user. On success the client is redirected to /login.
      consumes:
        - application/x-www-form-urlencoded
      produces:
        - text/html
      tags:
        - API
      summary: Register
      parameters:
        - name: username
          in: formData
          description: Username
          required: true
          type: string
        - name: email
          in: formData
          description: Email address
          required: true
          type: string
        - name: password
          in: formData
          description: Password
          required: true
          type: string
        - name: password2
          in: formData
          description: Password confirmation
          required: true
          type: string
      responses:
        "302":
          description: Redirect to /login after successful registration
        "200":
          description: Registration page with validation errors

  /api/search:
    get:
      # Ingen security-override -> kræver session-cookie
      description: Search for stored pages and cached Wikipedia content. When the query is empty, an empty result set is returned.
      produces:
        - application/json
      tags:
        - API
      summary: Search
      parameters:
        - name: q
          in: query
          description: Search query string
          required: false
          type: string
        - name: language
          in: query
          description: "Language code (default: en)"
          required: false
          type: string
      responses:
        "200":
          description: Search results
          schema:
            $ref: '#/definitions/handlers.SearchResponse'

  /api/weather:
    get:
      # Ingen security-override -> kræver session-cookie
      description: Returns the current Copenhagen forecast used by the /weather page.
      produces:
        - application/json
      tags:
        - API
      summary: Get weather forecast
      responses:
        "200":
          description: Forecast retrieved
          schema:
            $ref: '#/definitions/handlers.WeatherAPIResponse'
        "503":
          description: Weather service unavailable
          schema:
            $ref: '#/definitions/handlers.APIErrorResponse'

  /healthz:
    get:
      security: []  # Public
      produces:
        - text/plain
      tags:
        - Health
      summary: Liveness probe
      responses:
        "200":
          description: Service is healthy
          schema:
            type: string
            example: ok
        "500":
          description: Internal error writing response

  /login:
    get:
      security: []  # Public
      produces:
        - text/html
      tags:
        - Pages
      summary: Serve Login Page
      responses:
        "200":
          description: HTML content
          schema:
            type: string

  /readyz:
    get:
      security: []  # Public
      produces:
        - text/plain
      tags:
        - Health
      summary: Readiness probe
      responses:
        "200":
          description: Database connection is ready
          schema:
            type: string
            example: ready
        "503":
          description: Database not configured or not reachable
          schema:
            type: string
            example: database not ready

  /register:
    get:
      security: []  # Public
      produces:
        - text/html
      tags:
        - Pages
      summary: Serve Register Page
      responses:
        "200":
          description: HTML content
          schema:
            type: string

definitions:
  handlers.APIErrorResponse:
    type: object
    properties:
      error:
        type: string
        example: weather service unavailable

  handlers.SearchResponse:
    type: object
    properties:
      search_results:
        type: array
        maxItems: 50
        items:
          $ref: '#/definitions/handlers.SearchResult'

  handlers.SearchResult:
    type: object
    properties:
      Description:
        type: string
        example: Short description
      ID:
        type: integer
        example: 1
      Language:
        type: string
        example: en
      Title:
        type: string
        example: Example page title
      URL:
        type: string
        example: https://example.com

  handlers.WeatherAPIResponse:
    type: object
    properties:
      forecast:
        $ref: '#/definitions/handlers.WeatherForecast'
      location:
        $ref: '#/definitions/handlers.WeatherLocation'

  handlers.WeatherForecast:
    type: object
    properties:
      step:
        type: string
        example: PT1H
      temperature:
        type: number
        example: 12.3
      wind_direction:
        type: number
        example: 225
      wind_speed:
        type: number
        example: 4.5

  handlers.WeatherLocation:
    type: object
    properties:
      latitude:
        type: number
        example: 55.715
      longitude:
        type: number
        example: 12.561

  main.AuthResponse:
    type: object
    properties:
      message:
        type: string
        example: Login successful
      statusCode:
        type: integer
        example: 200
